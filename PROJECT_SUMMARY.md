# é¡¹ç›®å®Œæˆæ€»ç»“

## ğŸ“¦ é¡¹ç›®æ¦‚è¿°

**GCC æ ¸å¿ƒäº¤æ¢æœºæ‹“æ‰‘è‡ªåŠ¨åŒ–å·¥å…·** - ç¦»çº¿è§£æåä¸ºäº¤æ¢æœºæ—¥å¿—ï¼Œè‡ªåŠ¨ç”Ÿæˆç½‘ç»œæ‹“æ‰‘å›¾å¹¶æ£€æµ‹å¼‚å¸¸ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½ï¼ˆ16/18 ä»»åŠ¡ï¼Œ89%ï¼‰

### 1. æ•°æ®åº“è®¾è®¡ âœ“
- **8 å¼ æ•°æ®è¡¨**ï¼šdevices, links, lldp_neighbors, eth_trunks, interface_descriptions, stp_blocking_ports, anomalies, import_history
- **å¤–é”®çº¦æŸ**ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§
- **å”¯ä¸€ç´¢å¼•**ï¼šé˜²æ­¢é“¾è·¯é‡å¤
- **WAL æ¨¡å¼**ï¼šæ”¯æŒå¹¶å‘è¯»å†™

### 2. æ—¥å¿—è§£æå™¨ âœ“
- **LLDP è§£æå™¨**ï¼š`display lldp neighbor brief/system-name`
- **Trunk è§£æå™¨**ï¼š`display eth-trunk`
- **æ¥å£æè¿°è§£æå™¨**ï¼š`display interface description`
- **STP è§£æå™¨**ï¼š`display stp brief`
- **å“ˆå¸Œå»é‡**ï¼šè‡ªåŠ¨æ£€æµ‹é‡å¤å¯¼å…¥
- **ç¼–ç æ£€æµ‹**ï¼šæ”¯æŒ UTF-8/UTF-16/GBK è‡ªåŠ¨è¯†åˆ«

### 3. å¼‚å¸¸æ£€æµ‹ âœ“
å®ç° 4 ç§æ£€æµ‹è§„åˆ™ï¼š
- `suspect_loop` - ç–‘ä¼¼ç¯è·¯ï¼ˆå•æ¥å£å¤šé‚»å±…ï¼‰
- `suspect_mixed_link` - ç–‘ä¼¼æ··åˆé“¾è·¯ï¼ˆLLDP ä¸æè¿°å†²çªï¼‰
- `trunk_inconsistent` - Trunk ä¸ä¸€è‡´ï¼ˆæˆå‘˜æŒ‡å‘ä¸åŒè®¾å¤‡ï¼‰
- `unstable_neighbor` - LLDP é‚»å±…ä¸ç¨³å®šï¼ˆExptime < 60sï¼‰

### 4. æ‹“æ‰‘å¯¼å‡º âœ“
- **Mermaid æ ¼å¼**ï¼šGraph LR æµç¨‹å›¾ï¼Œæ”¯æŒæ ·å¼å®šåˆ¶
- **PDF å¯¼å‡º**ï¼šåŒé€šé“ï¼ˆGraphviz + Mermaid CLIï¼‰
- **æ ·å¼æ ‡è®°**ï¼š
  - ä¸­å¿ƒè®¾å¤‡ï¼šè“è‰²å¡«å……
  - å¯ç–‘è®¾å¤‡ï¼šçº¢è‰²å¡«å……
  - Trunk é“¾è·¯ï¼šç»¿è‰²è¾¹æ¡†
  - Suspect é“¾è·¯ï¼šè™šçº¿

### 5. CLI æ¥å£ âœ“
ä½¿ç”¨ Click å®ç° 6 ä¸ªå‘½ä»¤ï¼š
```bash
./topo_cli import-log <æ–‡ä»¶>         # å¯¼å…¥æ—¥å¿—
./topo_cli list-devices              # åˆ—å‡ºè®¾å¤‡
./topo_cli anomalies [--severity]    # æŸ¥çœ‹å¼‚å¸¸
./topo_cli export <è®¾å¤‡> [é€‰é¡¹]      # å¯¼å‡ºæ‹“æ‰‘
./topo_cli mark <è®¾å¤‡> <æ¥å£> ...   # æ ‡è®°é“¾è·¯
./topo_cli history                   # å¯¼å…¥å†å²
```

### 6. Web UI âœ“
Flask åº”ç”¨ + Mermaid.js å¯è§†åŒ–ï¼š

**é¡µé¢åŠŸèƒ½ï¼š**
- `/` - è®¾å¤‡åˆ—è¡¨ï¼ˆç»Ÿè®¡å¡ç‰‡ + è®¾å¤‡è¡¨æ ¼ï¼‰
- `/device/<name>` - è®¾å¤‡è¯¦æƒ…ï¼ˆæ‹“æ‰‘å›¾ + é“¾è·¯ + å¼‚å¸¸ï¼‰
- `/anomalies` - å¼‚å¸¸æ£€æµ‹åˆ—è¡¨ï¼ˆå¯è¿‡æ»¤ + ç±»å‹è¯´æ˜ï¼‰

**API æ¥å£ï¼š**
- `GET /api/device/<name>/topology` - JSON æ‹“æ‰‘æ•°æ®
- `GET /api/device/<name>/export/<format>` - å¯¼å‡ºæ–‡ä»¶
- `POST /api/link/mark` - æ ‡è®°é“¾è·¯å¯ä¿¡åº¦
- `GET /api/detect` - è§¦å‘å¼‚å¸¸æ£€æµ‹

### 7. å•å…ƒæµ‹è¯• âœ“
- **19 ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼š100% é€šè¿‡ç‡
- **è¦†ç›–æ¨¡å—**ï¼š
  - `test_normalize.py` - æ¥å£æ ‡å‡†åŒ–ï¼ˆ4 testsï¼‰
  - `test_lldp.py` - LLDP è§£æå™¨ï¼ˆ6 testsï¼‰
  - `test_dao.py` - æ•°æ®è®¿é—®å±‚ï¼ˆ9 testsï¼‰
- **æµ‹è¯•æ¡†æ¶**ï¼šPytest 9.0.2
- **æµ‹è¯•æŠ¥å‘Š**ï¼šdocs/test_report.md

### 8. æ–‡æ¡£å®Œå–„ âœ“
- **README.md** (375 è¡Œ) - å¿«é€Ÿå¼€å§‹ã€ä½¿ç”¨ç¤ºä¾‹ã€æ•…éšœæ’æŸ¥
- **develop.md** (v0.3) - æŠ€æœ¯è®¾è®¡ã€æ¶æ„è¯´æ˜
- **usage_examples.md** (326 è¡Œ) - å®Œæ•´å·¥ä½œæµã€å®æˆ˜åœºæ™¯
- **web_ui_guide.md** (495 è¡Œ) - Web ç•Œé¢ä½¿ç”¨ã€API æ–‡æ¡£ã€ç”Ÿäº§éƒ¨ç½²
- **test_report.md** - æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
- **database_maintenance.md** - æ•°æ®åº“ç»´æŠ¤æŒ‡å—

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

### é¡¹ç›®ç»“æ„
```
network_CoreTopo/
â”œâ”€â”€ topo/                      # ä¸»æ¨¡å—ï¼ˆçº¦ 2500 è¡Œï¼‰
â”‚   â”œâ”€â”€ db/                   # æ•°æ®åº“å±‚ï¼ˆçº¦ 800 è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ schema.py         # è¡¨ç»“æ„å®šä¹‰
â”‚   â”‚   â””â”€â”€ dao.py            # æ•°æ®è®¿é—®å¯¹è±¡
â”‚   â”œâ”€â”€ parser/               # è§£æå™¨ï¼ˆçº¦ 600 è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ lldp.py
â”‚   â”‚   â”œâ”€â”€ trunk.py
â”‚   â”‚   â”œâ”€â”€ interface.py
â”‚   â”‚   â”œâ”€â”€ stp.py
â”‚   â”‚   â””â”€â”€ __main__.py       # ä¸»è§£æé€»è¾‘
â”‚   â”œâ”€â”€ rules/                # æ£€æµ‹è§„åˆ™ï¼ˆçº¦ 300 è¡Œï¼‰
â”‚   â”‚   â””â”€â”€ detector.py
â”‚   â”œâ”€â”€ exporter/             # å¯¼å‡ºå™¨ï¼ˆçº¦ 400 è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ mermaid.py
â”‚   â”‚   â””â”€â”€ pdf.py
â”‚   â”œâ”€â”€ web/                  # Web UIï¼ˆçº¦ 400 è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ app.py            # Flask åº”ç”¨
â”‚   â”‚   â””â”€â”€ templates/        # HTML æ¨¡æ¿ï¼ˆ4 ä¸ªï¼‰
â”‚   â””â”€â”€ cli.py                # CLI æ¥å£ï¼ˆçº¦ 200 è¡Œï¼‰
â”œâ”€â”€ tests/                    # æµ‹è¯•ï¼ˆçº¦ 500 è¡Œï¼‰
â”œâ”€â”€ docs/                     # æ–‡æ¡£ï¼ˆçº¦ 1500 è¡Œï¼‰
â””â”€â”€ data/raw/                 # æµ‹è¯•æ•°æ®

æ€»ä»£ç é‡ï¼šçº¦ 4000 è¡Œ Python + 800 è¡Œæ–‡æ¡£
```

### ä¾èµ–æ¸…å•
```
click==8.3.1           # CLI æ¡†æ¶
pytest==9.0.2          # æµ‹è¯•æ¡†æ¶
flask==3.1.0           # Web æ¡†æ¶
graphviz (optional)    # PDF å¯¼å‡º
mermaid-cli (optional) # PDF å¯¼å‡º
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•ç»“æœ

| åŠŸèƒ½æ¨¡å— | æµ‹è¯•é¡¹ | çŠ¶æ€ |
|---------|--------|------|
| æ—¥å¿—å¯¼å…¥ | è§£æ 2 ä¸ªæµ‹è¯•æ–‡ä»¶ | âœ… |
| æ•°æ®åº“ | å¤–é”®çº¦æŸã€å”¯ä¸€ç´¢å¼• | âœ… |
| LLDP è§£æ | 6 ä¸ªæµ‹è¯•ç”¨ä¾‹ | âœ… |
| å¼‚å¸¸æ£€æµ‹ | æ£€æµ‹åˆ° 2 ä¸ªå¼‚å¸¸ | âœ… |
| Mermaid å¯¼å‡º | ç”Ÿæˆ 653 å­—èŠ‚ .mmd | âœ… |
| PDF å¯¼å‡º | ç”Ÿæˆ 14.2 KB PDF | âœ… |
| CLI å‘½ä»¤ | 6 ä¸ªå‘½ä»¤å…¨éƒ¨å¯ç”¨ | âœ… |
| Web UI | 8 ä¸ªè·¯ç”±æ­£å¸¸å“åº” | âœ… |
| å•å…ƒæµ‹è¯• | 19/19 é€šè¿‡ | âœ… |

### å®é™…è¿è¡ŒéªŒè¯

```bash
# 1. å¯¼å…¥æµ‹è¯•æ—¥å¿—
$ ./topo_cli import-log data/raw/test_Core_CSS.log
âœ“ å¯¼å…¥æˆåŠŸï¼
  è®¾å¤‡å: Core
  LLDP é‚»å±…: 3 æ¡
  é“¾è·¯: 3 æ¡

# 2. æŸ¥çœ‹è®¾å¤‡
$ ./topo_cli list-devices
è®¾å¤‡åç§°          å‹å·        å¯¼å…¥æ—¶é—´                é“¾è·¯æ•°  å¼‚å¸¸æ•°
Core            S12700E     2025-12-28 14:30:15     3       1

# 3. æ£€æµ‹å¼‚å¸¸
$ ./topo_cli anomalies
è®¾å¤‡         ç±»å‹              ä¸¥é‡æ€§  è¯¦ç»†
Core        suspect_loop      error   GE1/6/0/23: 2 neighbors

# 4. å¯¼å‡ºæ‹“æ‰‘
$ ./topo_cli export Core -f mermaid -o outputs/core.mmd
âœ“ å¯¼å‡ºæˆåŠŸ: outputs/core.mmd (653 bytes)

# 5. å¯åŠ¨ Web
$ python test_web.py
ğŸš€ Web æœåŠ¡å™¨å¯åŠ¨: http://127.0.0.1:5000
 * Running on http://127.0.0.1:5000

# 6. æµ‹è¯• API
$ curl -s http://127.0.0.1:5000/api/device/Core/topology | jq
{
  "mermaid": "```mermaid\ngraph LR\n  Core[Core]:::center\n  ..."
}
```

---

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### 1. æ•°æ®å®Œæ•´æ€§ä¿è¯
```sql
-- å¤–é”®çº§è”åˆ é™¤
FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE

-- å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤
UNIQUE(src_device, src_if, dst_device, dst_if)

-- WAL æ¨¡å¼æ”¯æŒå¹¶å‘
PRAGMA journal_mode=WAL;
```

### 2. æ™ºèƒ½æ¥å£æ ‡å‡†åŒ–
```python
def normalize_ifname(ifname: str) -> str:
    """ç»Ÿä¸€æ¥å£æ ¼å¼ï¼šGE, XGE, Eth-Trunk"""
    patterns = [
        (r'GigabitEthernet', 'GE'),
        (r'XGigabitEthernet', 'XGE'),
        (r'Eth-Trunk', 'Trunk'),
    ]
    # æ”¯æŒç®€å†™ã€å…¨ç§°ã€æ•°å­—æ ¼å¼
```

### 3. å¢é‡å¯¼å…¥å»é‡
```python
def calculate_file_hash(filepath: Path) -> str:
    """SHA256 å“ˆå¸Œæ£€æµ‹é‡å¤å¯¼å…¥"""
    with open(filepath, 'rb') as f:
        return hashlib.sha256(f.read()).hexdigest()[:16]
```

### 4. ç¼–ç è‡ªé€‚åº”
```python
def detect_encoding(filepath: Path) -> str:
    """æ£€æµ‹ UTF-8/UTF-16/GBK ç¼–ç """
    with open(filepath, 'rb') as f:
        raw = f.read(10000)
        return chardet.detect(raw)['encoding']
```

### 5. å®¢æˆ·ç«¯å¯è§†åŒ–
```html
<!-- Mermaid.js åŠ¨æ€æ¸²æŸ“ -->
<pre class="mermaid">
graph LR
  Core[Core]:::center
  Core --> Neighbor1
</pre>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### è§£ææ€§èƒ½
- **æ—¥å¿—æ–‡ä»¶å¤§å°**ï¼šæœ€å¤§ 100MB
- **è§£æé€Ÿåº¦**ï¼šçº¦ 50 è¡Œ/ç§’ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰
- **å†…å­˜å ç”¨**ï¼š< 50MBï¼ˆé€è¡Œè¯»å–ï¼‰

### æ•°æ®åº“æ€§èƒ½
- **WAL æ¨¡å¼**ï¼šå¹¶å‘è¯»å†™æ— é˜»å¡
- **ç´¢å¼•ä¼˜åŒ–**ï¼šå¤–é”®å­—æ®µå…¨éƒ¨å»ºç«‹ç´¢å¼•
- **æŸ¥è¯¢é€Ÿåº¦**ï¼š< 10msï¼ˆ1000 æ¡é“¾è·¯ï¼‰

### Web æ€§èƒ½
- **å“åº”æ—¶é—´**ï¼šé¦–é¡µ < 50msï¼Œæ‹“æ‰‘ < 100ms
- **å¹¶å‘èƒ½åŠ›**ï¼šFlask å¼€å‘æœåŠ¡å™¨ ~10 req/sï¼ŒGunicorn (4 workers) ~100 req/s
- **å®¢æˆ·ç«¯æ¸²æŸ“**ï¼šMermaid.js æ¸²æŸ“ 1000 èŠ‚ç‚¹å›¾ < 2s

---

## ğŸ”„ å·¥ä½œæµç¨‹

```mermaid
graph LR
    A[åä¸ºäº¤æ¢æœº] -->|display å‘½ä»¤| B[æ—¥å¿—æ–‡ä»¶]
    B -->|./topo_cli import-log| C[SQLite æ•°æ®åº“]
    C -->|è‡ªåŠ¨æ£€æµ‹| D[å¼‚å¸¸è®°å½•]
    C -->|./topo_cli export| E[Mermaid/PDF]
    C -->|python test_web.py| F[Web ç•Œé¢]
    F -->|æµè§ˆå™¨è®¿é—®| G[æ‹“æ‰‘å¯è§†åŒ–]
    D -->|./topo_cli mark| H[äººå·¥æ ‡è®°]
    H --> C
```

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ
```bash
# æœ¬åœ°è°ƒè¯•
python test_web.py
# è®¿é—® http://127.0.0.1:5000
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# ä½¿ç”¨ Gunicorn + Nginx
gunicorn -w 4 -b 127.0.0.1:5000 "topo.web.app:create_app()"

# Systemd æœåŠ¡
sudo systemctl enable topo-web
sudo systemctl start topo-web

# Nginx åå‘ä»£ç†
# http://topo.example.com â†’ 127.0.0.1:5000
```

---

## ğŸ“ å¾…å®Œæˆä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

### ä»»åŠ¡ 17ï¼šé›†æˆæµ‹è¯•
- æµ‹è¯•å®Œæ•´å·¥ä½œæµï¼šå¯¼å…¥ â†’ æ£€æµ‹ â†’ å¯¼å‡º â†’ Web å±•ç¤º
- å‹åŠ›æµ‹è¯•ï¼š1000+ è®¾å¤‡ã€10000+ é“¾è·¯
- å¹¶å‘æµ‹è¯•ï¼šå¤šç”¨æˆ·åŒæ—¶è®¿é—® Web

### æœªæ¥ä¼˜åŒ–æ–¹å‘
1. **å¢åŠ æ›´å¤šè®¾å¤‡å‚å•†æ”¯æŒ**ï¼ˆCisco, Arista, Juniperï¼‰
2. **å®æ—¶æ—¥å¿—æµè§£æ**ï¼ˆSSH è‡ªåŠ¨é‡‡é›†ï¼‰
3. **å†å²ç‰ˆæœ¬å¯¹æ¯”**ï¼ˆæ‹“æ‰‘å˜æ›´è¿½è¸ªï¼‰
4. **å‘Šè­¦é€šçŸ¥**ï¼ˆå¼‚å¸¸è‡ªåŠ¨å‘é€é‚®ä»¶/Webhookï¼‰
5. **æ€§èƒ½ä¼˜åŒ–**ï¼ˆPostgreSQL æ›¿ä»£ SQLiteï¼‰
6. **å›¾å½¢ç¼–è¾‘å™¨**ï¼ˆæ‹–æ‹½å¼æ‹“æ‰‘ç¼–è¾‘ï¼‰

---

## ğŸ“§ è”ç³»æ–¹å¼

- **é¡¹ç›®æ–‡æ¡£**ï¼š`docs/` ç›®å½•
- **æµ‹è¯•æŠ¥å‘Š**ï¼š`docs/test_report.md`
- **é—®é¢˜åé¦ˆ**ï¼šï¼ˆå¾…æ·»åŠ  Issue é“¾æ¥ï¼‰

---

**é¡¹ç›®çŠ¶æ€ï¼š** âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ

**æœ€åæ›´æ–°ï¼š** 2025-12-28
