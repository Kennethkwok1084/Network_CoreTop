{% extends "base.html" %}

{% block title %}ä»»åŠ¡ç®¡ç†{% endblock %}

{% block content %}
<h2 style="color: #2c3e50; margin-bottom: 20px;">ğŸ“‹ é‡‡é›†ä»»åŠ¡ç®¡ç†</h2>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>ä»»åŠ¡ ID</th>
                <th>è®¾å¤‡åç§°</th>
                <th>è®¾å¤‡ IP</th>
                <th>ä»»åŠ¡ç±»å‹</th>
                <th>çŠ¶æ€</th>
                <th>å¼€å§‹æ—¶é—´</th>
                <th>å®Œæˆæ—¶é—´</th>
                <th>è€—æ—¶</th>
                <th>æ—¥å¿—æ–‡ä»¶</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% if tasks %}
            {% for task in tasks %}
            <tr>
                <td><strong>#{{ task.id }}</strong></td>
                <td>{{ task.device_name }}</td>
                <td>{{ task.mgmt_ip }}</td>
                <td>
                    {% if task.task_type == 'manual' %}
                    <span class="badge badge-info">æ‰‹åŠ¨</span>
                    {% elif task.task_type == 'scheduled' %}
                    <span class="badge badge-primary">å®šæ—¶</span>
                    {% else %}
                    <span class="badge badge-secondary">è‡ªåŠ¨</span>
                    {% endif %}
                </td>
                <td>
                    {% if task.status == 'pending' %}
                    <span class="badge badge-secondary">å¾…æ‰§è¡Œ</span>
                    {% elif task.status == 'running' %}
                    <span class="badge badge-primary">æ‰§è¡Œä¸­</span>
                    {% elif task.status == 'success' %}
                    <span class="badge badge-success">æˆåŠŸ</span>
                    {% else %}
                    <span class="badge badge-danger">å¤±è´¥</span>
                    {% endif %}
                </td>
                <td>{{ task.started_at[:19] if task.started_at else '-' }}</td>
                <td>{{ task.completed_at[:19] if task.completed_at else '-' }}</td>
                <td>
                    {% if task.started_at and task.completed_at %}
                    {{ format_duration(task.started_at, task.completed_at) }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if task.log_file_path %}
                    <a href="{{ task.log_file_path }}" style="color: #1890ff;">ğŸ“„ æŸ¥çœ‹</a>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if task.status == 'pending' %}
                    <form method="POST" action="{{ url_for('execute_task', task_id=task.id) }}"
                        style="display: inline;">
                        <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
                        <button type="submit" class="btn btn-sm" style="background: #52c41a; color: white;">æ‰§è¡Œ</button>
                    </form>
                    {% elif task.status == 'running' %}
                    <button class="btn btn-sm" onclick="showLogs({{ task.id }})"
                        style="background: #1890ff; color: white;">ğŸ“¡ æŸ¥çœ‹æ—¥å¿—</button>
                    {% elif task.status == 'failed' %}
                    <button class="btn btn-sm" onclick="showError({{ task.id }}, '{{ task.error_message | replace("'", "\\'") | replace('"', '\\"') | replace("\n", "\\n") if task.error_message else "æœªçŸ¥é”™è¯¯" }}')"
                        style="background: #ff4d4f; color: white;">âš ï¸ æŸ¥çœ‹é”™è¯¯</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="10" style="text-align: center; padding: 40px; color: #999;">
                    æš‚æ— ä»»åŠ¡è®°å½•
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<div style="margin-top: 20px; padding: 15px; background: #f0f7ff; border-left: 4px solid #1890ff; border-radius: 4px;">
    <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>
    <ul style="margin: 10px 0 0 20px; color: #666;">
        <li><strong>æ‰‹åŠ¨ä»»åŠ¡ï¼š</strong>åœ¨è®¾å¤‡ç®¡ç†é¡µé¢ç‚¹å‡»"é‡‡é›†"æŒ‰é’®åˆ›å»º</li>
        <li><strong>å®šæ—¶ä»»åŠ¡ï¼š</strong>é€šè¿‡ä»»åŠ¡è°ƒåº¦ç³»ç»ŸæŒ‰è®¡åˆ’æ‰§è¡Œ</li>
        <li><strong>è‡ªåŠ¨ä»»åŠ¡ï¼š</strong>è®¾å¤‡å¯ç”¨è‡ªåŠ¨é‡‡é›†åè‡ªåŠ¨åˆ›å»º</li>
        <li><strong>æ—¥å¿—æ–‡ä»¶ï¼š</strong>é‡‡é›†æˆåŠŸåä¼šä¿å­˜åˆ° data/raw/ ç›®å½•ï¼Œå¯ç›´æ¥å¯¼å…¥è§£æ</li>
    </ul>
</div>

<!-- å®æ—¶æ—¥å¿—å¼¹çª— -->
<div id="logModal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div
        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 900px; max-height: 80vh; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div
            style="padding: 20px; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #2c3e50;">ğŸ“¡ å®æ—¶é‡‡é›†æ—¥å¿—</h3>
            <button onclick="closeLogs()"
                style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        <div id="logContent"
            style="padding: 20px; max-height: calc(80vh - 100px); overflow-y: auto; background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; line-height: 1.6;">
            <div style="color: #4ec9b0;">æ­£åœ¨è¿æ¥æ—¥å¿—æµ...</div>
        </div>
    </div>
</div>

<script>
    let eventSource = null;

    function showLogs(taskId) {
        const modal = document.getElementById('logModal');
        const logContent = document.getElementById('logContent');
        modal.style.display = 'block';
        logContent.innerHTML = '<div style="color: #4ec9b0;">[ç³»ç»Ÿ] æ­£åœ¨è¿æ¥åˆ°ä»»åŠ¡ #' + taskId + ' çš„æ—¥å¿—æµ...</div>';

        // å…³é—­ä¹‹å‰çš„è¿æ¥
        if (eventSource) {
            eventSource.close();
        }

        // å»ºç«‹ SSE è¿æ¥
        eventSource = new EventSource('/manage/tasks/' + taskId + '/logs');

        eventSource.onmessage = function (event) {
            const log = JSON.parse(event.data);
            const timestamp = log.timestamp;
            const message = log.message;

            let color = '#d4d4d4';  // é»˜è®¤ç™½è‰²
            let icon = 'â€¢';

            if (log.type === 'connected') {
                color = '#4ec9b0';  // é’è‰²
                icon = 'âœ“';
            } else if (log.type === 'info') {
                color = '#9cdcfe';  // æµ…è“
                icon = 'â„¹';
            } else if (log.type === 'success') {
                color = '#4ec9b0';  // ç»¿è‰²
                icon = 'âœ“';
            } else if (log.type === 'error') {
                color = '#f48771';  // çº¢è‰²
                icon = 'âœ—';
            } else if (log.type === 'command') {
                color = '#dcdcaa';  // é»„è‰²
                icon = 'â–º';
            } else if (log.type === 'output') {
                color = '#ce9178';  // æ©™è‰²
                icon = 'â—„';
            }

            const logLine = '<div style="margin-bottom: 4px;"><span style="color: #858585;">[' + timestamp + ']</span> <span style="color: ' + color + ';">' + icon + ' ' + escapeHtml(message) + '</span></div>';
            logContent.innerHTML += logLine;
            logContent.scrollTop = logContent.scrollHeight;
        };

        eventSource.onerror = function () {
            logContent.innerHTML += '<div style="color: #f48771; margin-top: 10px;">[ç³»ç»Ÿ] è¿æ¥å·²æ–­å¼€</div>';
            eventSource.close();
            eventSource = null;
        };
    }

    function closeLogs() {
        document.getElementById('logModal').style.display = 'none';
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
    }

    function showError(taskId, errorMessage) {
        const modal = document.getElementById('logModal');
        const logContent = document.getElementById('logContent');
        const title = modal.querySelector('h3');
        
        title.textContent = 'âš ï¸ ä»»åŠ¡æ‰§è¡Œé”™è¯¯';
        modal.style.display = 'block';
        
        logContent.innerHTML = `
            <div style="color: #f48771; font-size: 14px; line-height: 1.8;">
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(244, 135, 113, 0.1); border-left: 3px solid #f48771;">
                    <strong>ä»»åŠ¡ ID:</strong> #${taskId}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>é”™è¯¯ä¿¡æ¯:</strong>
                </div>
                <div style="padding: 15px; background: rgba(244, 135, 113, 0.05); border-radius: 4px; white-space: pre-wrap; color: #d4d4d4;">
                    ${escapeHtml(errorMessage || 'æœªçŸ¥é”™è¯¯')}
                </div>
                <div style="margin-top: 20px; color: #4ec9b0;">
                    <strong>ğŸ’¡ å¸¸è§é—®é¢˜æ’æŸ¥:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li><strong>FERNET_KEY æœªè®¾ç½®:</strong> è¿è¡Œ <code style="background: #2d2d2d; padding: 2px 6px; border-radius: 3px;">export FERNET_KEY='å¯†é’¥'</code></li>
                        <li><strong>SSH è¿æ¥å¤±è´¥:</strong> æ£€æŸ¥è®¾å¤‡IPã€ç«¯å£ã€ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡®</li>
                        <li><strong>è®¤è¯å¤±è´¥:</strong> éªŒè¯SSHå‡­è¯æ˜¯å¦æœ‰æ•ˆ</li>
                        <li><strong>è¶…æ—¶é”™è¯¯:</strong> æ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œé˜²ç«å¢™è®¾ç½®</li>
                        <li><strong>ä¸»æœºå¯†é’¥éªŒè¯å¤±è´¥:</strong> è¿è¡Œ <code style="background: #2d2d2d; padding: 2px 6px; border-radius: 3px;">ssh-keyscan IP >> ~/.ssh/known_hosts</code></li>
                    </ul>
                </div>
            </div>
        `;
        logContent.scrollTop = 0;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('logModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeLogs();
        }
    });
</script>
{% endblock %}