{% extends "base.html" %}

{% block title %}{{ device.name }} - è®¾å¤‡è¯¦æƒ…{% endblock %}

{% block extra_css %}
<style>
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .info-item {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .info-item label {
        display: block;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .info-item .value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #ffffff;
    }

    /* æ‹“æ‰‘å›¾å®¹å™¨ç¾åŒ– */
    .mermaid-container {
        background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        margin: 2rem 0;
        min-height: 400px;
    }

    .mermaid-container svg {
        max-width: 100%;
        height: auto;
    }

    /* å¡ç‰‡ç¾åŒ– */
    .card {
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid #e8e8e8;
    }

    .card h2 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.2rem 1.5rem;
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .card>*:not(h2) {
        padding: 1.5rem;
    }

    pre {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0 1rem 0;">
    <h2 style="color: #2c3e50;">
        <a href="/" style="color: #3498db; text-decoration: none;">â†</a>
        {{ device.name }}
    </h2>
    <div>
        <a href="/api/device/{{ device.name }}/export/mermaid" class="btn btn-primary" download>ä¸‹è½½ Mermaid</a>
        <a href="/api/device/{{ device.name }}/export/dot" class="btn btn-primary" download>ä¸‹è½½ DOT</a>
    </div>
</div>

<!-- è®¾å¤‡ä¿¡æ¯ -->
<div class="card">
    <h2>è®¾å¤‡ä¿¡æ¯</h2>
    <div class="detail-grid">
        <div class="info-item">
            <label>è®¾å¤‡å</label>
            <div class="value">{{ device.name }}</div>
        </div>
        <div class="info-item">
            <label>ç®¡ç† IP</label>
            <div class="value">{{ device.mgmt_ip or '-' }}</div>
        </div>
        <div class="info-item">
            <label>å‹å·</label>
            <div class="value">{{ device.model or '-' }}</div>
        </div>
        <div class="info-item">
            <label>åˆ›å»ºæ—¶é—´</label>
            <div class="value">{{ device.created_at }}</div>
        </div>
    </div>
</div>

<!-- æ‹“æ‰‘å›¾ -->
<div class="card">
    <h2>ğŸŒ ç½‘ç»œæ‹“æ‰‘å›¾</h2>
    <div id="topology-network" style="height: 600px; background: #f8f9fa; border-radius: 8px;"></div>
    <div style="padding: 1rem; background: #fff; border-top: 1px solid #e8e8e8;">
        <span style="margin-right: 20px;">
            <span
                style="display: inline-block; width: 16px; height: 16px; background: #1890ff; border-radius: 50%; margin-right: 5px;"></span>
            æ ¸å¿ƒè®¾å¤‡
        </span>
        <span style="margin-right: 20px;">
            <span
                style="display: inline-block; width: 16px; height: 16px; background: #52c41a; border-radius: 50%; margin-right: 5px;"></span>
            æ±‡èš/æ¥å…¥
        </span>
        <span style="margin-right: 20px;">
            <span
                style="display: inline-block; width: 16px; height: 16px; background: #fa8c16; border-radius: 50%; margin-right: 5px;"></span>
            é˜²ç«å¢™
        </span>
        <span>
            <span
                style="display: inline-block; width: 16px; height: 16px; background: #d9d9d9; border-radius: 50%; margin-right: 5px;"></span>
            æœªçŸ¥è®¾å¤‡
        </span>
    </div>
</div>

<!-- é“¾è·¯åˆ—è¡¨ -->
<div class="card">
    <h2>é“¾è·¯åˆ—è¡¨ ({{ links|length }} æ¡)</h2>
    {% if links %}
    <table>
        <thead>
            <tr>
                <th>æœ¬åœ°æ¥å£</th>
                <th>å¯¹ç«¯è®¾å¤‡</th>
                <th>å¯¹ç«¯æ¥å£</th>
                <th>ç±»å‹</th>
                <th>å¯ä¿¡åº¦</th>
                <th>å¤‡æ³¨</th>
            </tr>
        </thead>
        <tbody>
            {% for link in links %}
            <tr>
                <td>{{ link.src_if }}</td>
                <td><strong>{{ link.dst_device }}</strong></td>
                <td>{{ link.dst_if or '-' }}</td>
                <td>
                    {% if link.link_type == 'trunk' %}
                    <span class="badge badge-info">Trunk</span>
                    {% else %}
                    <span class="badge">ç‰©ç†</span>
                    {% endif %}
                </td>
                <td>
                    {% if link.confidence == 'trusted' %}
                    <span class="badge badge-success">å¯ä¿¡</span>
                    {% elif link.confidence == 'suspect' %}
                    <span class="badge badge-warning">å¯ç–‘</span>
                    {% else %}
                    <span class="badge">å¿½ç•¥</span>
                    {% endif %}
                </td>
                <td>{{ link.notes or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #7f8c8d;">æš‚æ— é“¾è·¯æ•°æ®</p>
    {% endif %}
</div>

<!-- å¼‚å¸¸åˆ—è¡¨ -->
{% if anomalies %}
<div class="card">
    <h2>æ£€æµ‹åˆ°çš„å¼‚å¸¸ ({{ anomalies|length }} ä¸ª)</h2>
    <table>
        <thead>
            <tr>
                <th>ç±»å‹</th>
                <th>ä¸¥é‡çº§åˆ«</th>
                <th>è¯¦æƒ…</th>
                <th>æ£€æµ‹æ—¶é—´</th>
            </tr>
        </thead>
        <tbody>
            {% for anomaly in anomalies %}
            <tr>
                <td><code>{{ anomaly.type }}</code></td>
                <td>
                    {% if anomaly.severity == 'error' %}
                    <span class="badge badge-danger">é”™è¯¯</span>
                    {% elif anomaly.severity == 'warning' %}
                    <span class="badge badge-warning">è­¦å‘Š</span>
                    {% else %}
                    <span class="badge badge-info">ä¿¡æ¯</span>
                    {% endif %}
                </td>
                <td style="font-size: 0.9rem;">{{ anomaly.detail_json or '-' }}</td>
                <td>{{ anomaly.created_at }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #52c41a; padding: 2rem; text-align: center;">âœ“ æ²¡æœ‰æ£€æµ‹åˆ°å¼‚å¸¸</p>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
<script>
// æ„å»ºvis.jsç½‘ç»œæ‹“æ‰‘å›¾
(function() {
    const links = {{ links | tojson }};
    const centerDevice = "{{ device.name }}";
    
    // æå–èŠ‚ç‚¹
    const nodesMap = new Map();
    const edgesArray = [];

    // æ·»åŠ ä¸­å¿ƒè®¾å¤‡
    nodesMap.set(centerDevice, {
        id: centerDevice,
        label: centerDevice,
        group: 'center',
        value: 30,
        title: `æ ¸å¿ƒè®¾å¤‡: ${centerDevice}`
    });

    // å¤„ç†é“¾è·¯
    links.forEach((link, idx) => {
        const dst = link.dst_device;

        // ç¡®å®šè®¾å¤‡ç±»å‹
        let group = 'normal';
        if (dst.includes('FW') || dst.includes('USG') || dst.includes('firewall')) {
            group = 'firewall';
        } else if (dst === 'Unknown' || /^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}$/i.test(dst)) {
            group = 'unknown';
        }

        // æ·»åŠ ç›®æ ‡èŠ‚ç‚¹
        if (!nodesMap.has(dst)) {
            nodesMap.set(dst, {
                id: dst,
                label: dst,
                group: group,
                value: 15,
                title: `è®¾å¤‡: ${dst}\næ¥å£: ${link.dst_if || 'N/A'}`
            });
        }

        // ç®€åŒ–æ¥å£å
        const simplifyIf = (ifname) => {
            if (!ifname) return '';
            return ifname.replace('GigabitEthernet', 'Gi')
                .replace('TenGigabitEthernet', '10Gi')
                .replace('Ten-GigabitEthernet', '10Gi')
                .replace('XGigabitEthernet', 'XGi');
        };

        // æ·»åŠ è¾¹
        edgesArray.push({
            id: `edge-${idx}`,
            from: centerDevice,
            to: dst,
            label: simplifyIf(link.src_if),
            arrows: 'to',
            smooth: { type: 'cubicBezier' },
            width: link.link_type === 'trunk' ? 3 : 1,
            color: link.link_type === 'trunk' ? '#52c41a' : '#69c0ff'
        });
    });

    // è½¬æ¢ä¸ºæ•°ç»„
    const nodes = new vis.DataSet(Array.from(nodesMap.values()));
    const edges = new vis.DataSet(edgesArray);

    // åˆ›å»ºç½‘ç»œ
    const container = document.getElementById('topology-network');
    const data = { nodes, edges };
    const options = {
        nodes: {
            shape: 'dot',
            size: 20,
            font: {
                size: 14,
                color: '#000',
                face: 'Arial'
            },
            borderWidth: 2,
            shadow: true
        },
        edges: {
            font: {
                size: 11,
                align: 'middle',
                color: '#666',
                strokeWidth: 3,
                strokeColor: '#fff'
            },
            smooth: {
                type: 'cubicBezier',
                roundness: 0.5
            }
        },
        groups: {
            center: {
                color: {
                    background: '#1890ff',
                    border: '#0050b3',
                    highlight: { background: '#40a9ff', border: '#096dd9' }
                },
                size: 30,
                font: { color: '#fff', size: 16, bold: true }
            },
            firewall: {
                color: {
                    background: '#fa8c16',
                    border: '#d46b08',
                    highlight: { background: '#ffa940', border: '#ad4e00' }
                },
                shape: 'diamond'
            },
            normal: {
                color: {
                    background: '#52c41a',
                    border: '#389e0d',
                    highlight: { background: '#73d13d', border: '#237804' }
                }
            },
            unknown: {
                color: {
                    background: '#d9d9d9',
                    border: '#bfbfbf',
                    highlight: { background: '#f0f0f0', border: '#8c8c8c' }
                },
                shape: 'box',
                shapeProperties: { borderDashes: [5, 5] }
            }
        },
        physics: {
            stabilization: { iterations: 200 },
            barnesHut: {
                gravitationalConstant: -8000,
                centralGravity: 0.3,
                springLength: 150,
                springConstant: 0.04,
                damping: 0.09
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 100,
            dragNodes: true,
            dragView: true,
            zoomView: true
        }
    };

    const network = new vis.Network(container, data, options);

    // ç‚¹å‡»èŠ‚ç‚¹è·³è½¬
    network.on('click', function (params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            if (nodeId !== centerDevice) {
                window.location.href = `/device/${nodeId}`;
            }
        }
    });
})();
</script>
{% endblock %}